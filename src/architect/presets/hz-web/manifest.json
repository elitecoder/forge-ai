{
  "preset": "hz-web",
  "version": 3,
  "description": "Web platform (Bazel + TypeScript)",
  "base_ref": "green",
  "dev_server": {
    "command": "cd ${REPO_ROOT} && npm run dev -- --port ${PORT}",
    "bazel_command": "cd ${REPO_ROOT} && bazel run //apps/squirrel:rspack_bundle_prod.serve -- --port ${PORT}",
    "health_url": "http://localhost:${PORT}/",
    "startup_timeout": 180
  },
  "pipelines": {
    "full": {
      "steps": ["code", "test", "code_review", "visual_test", "lint", "report", "create_pr"],
      "dependencies": {
        "code_review": ["code"],
        "lint": ["code_review"],
        "test": ["lint"],
        "visual_test": ["test"],
        "report": ["visual_test"],
        "create_pr": ["report"]
      },
      "revalidation_targets": ["test"]
    },
    "lightweight": {
      "steps": ["test", "code_review", "lint", "report", "create_pr"],
      "dependencies": {
        "lint": ["code_review"],
        "test": ["lint"],
        "report": ["test"],
        "create_pr": ["report"]
      },
      "revalidation_targets": ["test"]
    }
  },
  "models": {
    "fix": "sonnet",
    "code": "sonnet",
    "code_review": "opus",
    "visual_test": "sonnet",
    "judge": "haiku"
  },
  "steps": {
    "code": {
      "type": "ai",
      "description": "Implement code changes from plan",
      "pass_command": "cd {{REPO_ROOT}} && npm run build",
      "bazel_pass_command": "cd {{REPO_ROOT}} && bazel build {{BUILD_TARGETS}}",
      "judge": {"criteria_source": "plan", "max_retries": 3},
      "evidence": [
        {"rule": "command_succeeds", "command": "test -n \"$(git diff --stat HEAD)\" || test -n \"$(git ls-files --others --exclude-standard)\"", "cwd": "repo_root"},
        {"rule": "file_exists", "file_glob": "code-checklist.json", "max_age_seconds": 7200},
        {"rule": "file_exists", "file_glob": "build-result.json", "max_age_seconds": 7200},
        {"rule": "json_field_equals", "file": "build-result.json", "field_name": "passed", "expected_value": true}
      ]
    },
    "build": {
      "type": "command",
      "description": "Standalone build step (not in default pipelines). Add to steps + dependencies if needed.",
      "run_command": "cd {{REPO_ROOT}} && npm run build",
      "error_file": "build-errors.txt",
      "fix_hints": "Check build configuration and dependencies."
    },
    "lint": {
      "type": "command",
      "per_package": true,
      "parallel": true,
      "run_command": "cd {{REPO_ROOT}}/{{PACKAGE}} && npm run lint:fix 2>&1",
      "bazel_run_command": "cd {{REPO_ROOT}} && bazel run //{{PACKAGE}}:lint.fix 2>&1",
      "error_file": "lint-errors-{{PACKAGE_SLUG}}.txt",
      "fix_hints": "Run the linter locally and fix reported issues."
    },
    "test": {
      "type": "command",
      "per_package": true,
      "parallel": true,
      "run_command": "cd {{REPO_ROOT}}/{{PACKAGE}} && npm test",
      "bazel_run_command": "cd {{REPO_ROOT}} && bazel test //{{PACKAGE}}:wtr_test",
      "error_file": "test-errors-{{PACKAGE_SLUG}}.txt"
    },
    "code_review": {
      "type": "ai",
      "skill": "${PRESET_DIR}/skills/code-review.md",
      "two_phase": true,
      "description": "Two-phase review: reviewer finds issues, fixer resolves them",
      "judge": {"criteria_source": "findings", "max_retries": 3},
      "evidence": [
        {"rule": "file_exists", "file_glob": "code-review-verdict.json", "max_age_seconds": 7200},
        {"rule": "json_field_equals", "file": "code-review-verdict.json", "field_name": "verdict", "expected_value": "CLEAN"},
        {"rule": "file_exists", "file_glob": "code_review-checklist.json", "max_age_seconds": 7200}
      ]
    },
    "visual_test": {
      "type": "ai",
      "skill": "${PRESET_DIR}/skills/visual-test.md",
      "allowed_file_patterns": [],
      "judge": {"criteria_source": "visual_test_plan", "max_retries": 3},
      "evidence": [
        {"rule": "file_exists", "file_glob": "visual-test-plan.md", "max_age_seconds": 7200},
        {"rule": "file_exists", "file_glob": "*-test-results.json", "max_age_seconds": 7200},
        {"rule": "file_exists", "file_glob": "visual-test-dashboard.html"},
        {"rule": "file_exists", "file_glob": "verify-before-*.png", "min_file_size": 10000},
        {"rule": "file_exists", "file_glob": "verify-after-*.png", "min_file_size": 10000},
        {"rule": "file_exists", "file_glob": "visual_test-checklist.json", "max_age_seconds": 7200},
        {
          "rule": "json_schema",
          "file_glob": "*-test-results.json",
          "schema": {
            "required_fields": ["schemaVersion", "feature", "timestamp", "summary", "results"],
            "field_values": {"schemaVersion": 1},
            "summary_constraints": {"total": {"gte": 2}},
            "min_results": 2,
            "results_all_status": "PASS",
            "results_entry_required_fields": ["number", "title", "status", "assertions", "screenshots"],
            "forbidden_title_patterns": ["not.applicable", "no.visual", "backend.only", "no.ui", "not.required", "no.changes"]
          }
        }
      ]
    },
    "report": {
      "type": "inline",
      "description": "Summarize pipeline results to user"
    },
    "create_pr": {
      "type": "ai",
      "skill": "${PRESET_DIR}/skills/create-pr.md",
      "evidence": [
        {"rule": "all_predecessors_checkpointed"}
      ]
    }
  }
}
